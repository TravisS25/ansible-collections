---
- name: Testing cockroachdb settings
  hosts: localhost

  tasks:
    - delegate_to: 192.168.4.2
      remote_user: user
      block:
        - name: Install docker
          become: true
          import_role:
            name: traviss25.util.docker
            tasks_from: install
          vars:
            users:
              - user

        - name: Run vault deploy
          import_role:
            name: traviss25.pac.deploy
            tasks_from: vault
          vars:
            root_var:
              valid_status_codes:
                - 200
                - 204
              #token: hvs.agQJ5a4Lyp1ZUKs3yeE13mSu
              local_keys_file_store: /home/travis/docker-testing/vault/vault-keys
              local_tokens_file_store: /home/travis/docker-testing/vault/vault-tokens
              config_dir: /home/user/vault/config
              storage_path: /home/user/vault/data
              pki_settings:
                root:
                  mount_path: pac/root-pki
                  mount_api:
                    description: Pac root cert engine
                    config:
                      default_lease_ttl: 87600h
                      max_lease_ttl: 87600h
                      force_no_cache: true
                  cert_api:
                    common_name: pickacontractor.com
                  url_api:
                    issuing_certificates:
                      - http://vault.pickacontractor.com/v1/pac/root-pki/cert/ca
                    crl_distribution_points:
                      - http://vault.pickacontractor.com/v1/pac/root-pki/cert/crl
                  role_api:
                    role_name: pac
                    ttl: 87600h
                    allow_subdomains: true
                    allow_any_name: true
                    allowed_domains:
                      - pickacontractor.com
                int:
                  mount_path: pac/int-pki
                  mount_api:
                    description: Pac intermediate cert engine
                    config:
                      default_lease_ttl: 43800h
                      max_lease_ttl: 43800h
                      force_no_cache: true
                  cert_api:
                    common_name: pickacontractor.com
                  sign_cert_api:
                    common_name: pickacontractor.com
                  url_api:
                    issuing_certificates:
                      - http://vault.pickacontractor.com/v1/pac/int-pki/cert/ca
                    crl_distribution_points:
                      - http://vault.pickacontractor.com/v1/pac/int-pki/cert/crl
                  role_api:
                    role_name: pac
                    ttl: 43800h
                    allow_subdomains: true
                    allow_any_name: true
                    allowed_domains:
                      - pickacontractor.com
              token_settings:
                roles:
                  - role_name: local
                    token_bound_cidrs:
                      - 192.168.4.2/32
                tokens:
                  - role_name: local
                    display_name: pac-deploy
                    policies:
                      - pac-deploy
              policy_settings:
                policies:
                  - name: pac-deploy
                    policy: |
                      path "pac/*" {
                        capabilities = ["create", "read", "update", "patch", "delete", "list"]
                      }

                      path "auth/token/create/" {
                        capabilities = ["create", "read", "update", "patch", "delete", "list"]
                      }

        - name: Run cockroach deploy
          import_role:
            name: traviss25.pac.deploy
            tasks_from: cockroachdb
          vars:
            root_var:
              insecure: false
              valid_status_codes:
                - 200
                - 204
              vault:
                ip: 192.168.4.2
                port: :8200
                token: "{{ hostvars['localhost']['vault_token'] }}"
                cert_settings:
                  int_pki_mount_point: /pac/int-pki
                  issue_role: pac
              node_cert_request:
                alt_names: cockroachdb1.pickacontractor.com
                common_name: node
                ip_sans: 192.168.4.2
              client_cert_request:
                alt_names: cockroachdb1.pickacontractor.com
                common_name: user
                ip_sans: 192.168.4.2
              storage_path: /home/user/cockroachdb
              cluster_join: "192.168.4.2:26257,192.168.4.3:26257,192.168.4.4:26257"
              cockroach_certs_dir: /home/user/.cockroach-certs
